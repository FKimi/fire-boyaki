<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- æ—¥æœ¬èªã‚’å«ã‚€æ–‡å­—ã‚’æ­£ã—ãè¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š -->
  <meta charset="UTF-8">
  <!-- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®è¡¨ç¤ºã‚’é©åˆ‡ã«ã™ã‚‹è¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã¼ã‚„ãã‚·ãƒ¼ãƒˆ</title>
  <link rel="stylesheet" href="css/fire-boyaki.css">
</head>

<body>
  <header>
    <h1>ã¼ã‚„ãã‚·ãƒ¼ãƒˆ</h1>  
    <a>è‡ªç”±ã«ã¼ã‚„ãå ´æ‰€ã§ã™ï¼ˆä½¿ã„æ–¹ã¯è‡ªç”±ï¼ç‹¬ã‚Šè¨€ã€å‚™å¿˜éŒ²ã€æœ€è¿‘ã®å‡ºæ¥äº‹ã€æ€è€ƒãƒ¡ãƒ¢etcï¼‰ </a>   
    <!-- <h5> æ€è€ƒå®Ÿé¨“ã®å ´ã§ã™ï¼ˆä½¿ã„æ–¹ã¯è‡ªç”±ï¼šæ—¥ã€…ã®æ—¥å¸¸ã€é•å’Œæ„Ÿã€å‡ºæ¥äº‹ã‚„æ„Ÿæƒ³ã€ç™ºè¦‹ãªã©ã€‚æ€è€ƒã®å‚ã‚Œæµã—/è‡ªç”±ãƒ¡ãƒ¢etcï¼‰</h5>    -->
  </header>

  <main>  
    <input type="text" id="input" placeholder="ã¼ã‚„ãã‚’å…¥åŠ›ã—ã¦ã­"> 
    <div id="memo-list"></div> 
    <ul>     
        <li id="save">ä¿å­˜</li>
        <li id="clear">æ¶ˆå»</li>
    </ul>
  </main>  
    <!-- JavaScriptã‚’èª­ã¿è¾¼ã‚€éƒ¨åˆ† -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    
    <script type="module">
        // Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import {
            getFirestore,  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
            collection,    // ãƒ‡ãƒ¼ã‚¿ã®é›†åˆã«ã‚¢ã‚¯ã‚»ã‚¹
            addDoc,       // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            getDocs,       // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            deleteDoc,     // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            doc,           // ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§
            updateDoc      // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        // Firebaseã®è¨­å®šæƒ…å ±
        const firebaseConfig = {
            // ğŸ”½ã“ã®1è¡Œã‚’`git add .`ã™ã‚‹å‰ã«ä¸€æ—¦å‰Šé™¤ï¼    <!-- apiKey: "AIzaSyCaQMRnBVPCef_1zdDTNvrFlwDBnsFnuVY", -->

            authDomain: "boyakidefire.firebaseapp.com",
            projectId: "boyakidefire",
            storageBucket: "boyakidefire.firebasestorage.app",
            messagingSenderId: "724476525899",
            appId: "1:724476525899:web:a5b93ac077600b35ce7cce"
        };
        // Firebaseã®åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let memoList = [];  // ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadMemos() {
            try {
                // 'boyaki'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const querySnapshot = await getDocs(collection(db, "boyaki"));
                memoList = [];
                // å–å¾—ã—ãŸå„ãƒ‡ãƒ¼ã‚¿ã‚’memoListã«è¿½åŠ 
                querySnapshot.forEach((doc) => {
                    memoList.push({
                        id: doc.id,                    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
                        ...doc.data(),                 // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹
                        comments: doc.data().comments || []  // ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãªã„å ´åˆã¯ç©ºé…åˆ—ï¼‰
                    });
                });
                displayMemos();  // ãƒ¡ãƒ¢ã‚’ç”»é¢ã«è¡¨ç¤º
            } catch (error) {
                console.error("Error loading memos:", error);  // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
            }
        }
        // ãƒ¡ãƒ¢ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayMemos() {
            const memoArea = $("#memo-list");  // ãƒ¡ãƒ¢è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å–å¾—
            memoArea.empty();  // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢
            // ãƒ¡ãƒ¢ã‚’æ–°ã—ã„é †ã«è¡¨ç¤º
            const sortedMemos = memoList.sort((a, b) => {
                // æ—¥ä»˜ã‚’æ¯”è¼ƒã—ã¦æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆ
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;  // æ–°ã—ã„æ—¥ä»˜ãŒå…ˆã«æ¥ã‚‹ã‚ˆã†ã«
            });
            // ä¸¦ã³æ›¿ãˆãŸé…åˆ—ã‚’ä½¿ã£ã¦è¡¨ç¤º
            sortedMemos.forEach((memo) => {
                memoArea.append(`
                   <div class="memo-item">
                        <p>${memo.title}</p>  
                        <small>${memo.date}</small>  
                        <div class="comment-section">
                            <input type="text" class="comment-input" placeholder="è‡ªç”±ã‚³ãƒ¡ãƒ³ãƒˆ" data-memo-id="${memo.id}">
                            <button onclick="window.addCommentToMemo('${memo.id}')">ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</button>
                            <div class="comments-list">
                                ${(memo.comments || []).map(comment => `
                                    <div class="comment-item">
                                        <p>${comment.text}</p>  
                                        <small>${comment.date}</small>  
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `);
            });
        }
        // ä¿å­˜
        $("#save").on("click", async function () {
            // å…¥åŠ›ãŒç©ºã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            if (!$("#input").val()) {
                alert("ã¼ã‚„ã“ã†");
                return;
            }
            // æ–°ã—ã„ãƒ¡ãƒ¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const newMemo = {
                title: $("#input").val(),  // å…¥åŠ›ã•ã‚ŒãŸå†…å®¹
                date: new Date().toLocaleString(),  // ç¾åœ¨ã®æ—¥æ™‚
                comments: []  // ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ç©ºé…åˆ—
            };

            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„ãƒ¡ãƒ¢ã‚’è¿½åŠ 
                await addDoc(collection(db, "boyaki"), newMemo);
                $("#input").val("");  // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                alert("ä¿å­˜ã—ãŸã‚ˆï¼");
                await loadMemos();  // ãƒ¡ãƒ¢ã‚’å†èª­ã¿è¾¼ã¿
            } catch (error) {
                console.error("Error saving memo:", error);
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        });
        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        async function addComment(memoId, commentText) {
            try {
                // å¯¾è±¡ã®ãƒ¡ãƒ¢ã‚’å‚ç…§
                const memoRef = doc(db, "boyaki", memoId);
                const memo = memoList.find(m => m.id === memoId);
                // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
                const newComment = {
                    text: commentText,
                    date: new Date().toLocaleString()
                };
                // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã«æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                const updatedComments = [...(memo.comments || []), newComment];
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
                await updateDoc(memoRef, {
                    comments: updatedComments
                });
                
                await loadMemos();  // ãƒ¡ãƒ¢ã‚’å†èª­ã¿è¾¼ã¿
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("ã‚³ãƒ¡ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }
        // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLå†…ã®onclickã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
        window.addCommentToMemo = async function(memoId) {
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’å–å¾—
            const input = $(`.comment-input[data-memo-id="${memoId}"]`);
            const commentText = input.val();
            // å…¥åŠ›ãŒç©ºã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            if (!commentText) {
                alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            await addComment(memoId, commentText);
            input.val("");
        };
        // æ¶ˆå»
        $("#clear").on("click", async function () {
            if (!confirm("æœ¬å½“ã«ã™ã¹ã¦ã®ã¼ã‚„ãã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;

            try {
                // ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å–å¾—
                const querySnapshot = await getDocs(collection(db, "boyaki"));
                // å„ãƒ¡ãƒ¢ã‚’å‰Šé™¤
                const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                // ç”»é¢ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                memoList = [];
                $("#memo-list").empty();
                $("#input").val("");
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            } catch (error) {
                console.error("Error deleting memos:", error);
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        });

        // åˆæœŸè¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã‚€
        loadMemos();
    </script>
</body>
</html>
